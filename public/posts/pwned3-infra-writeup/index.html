<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="Atte Niemi">
    <meta name="description" content="Atte Niemi&#39;s personal website">
    <meta name="keywords" content="blog,developer,personal">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="pwnED 3 infrastructure writeup"/>
<meta name="twitter:description" content="Overview of infrastructure architecture for pwnEd 3 CTF"/>

    <meta property="og:title" content="pwnED 3 infrastructure writeup" />
<meta property="og:description" content="Overview of infrastructure architecture for pwnEd 3 CTF" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://www.atteniemi.com/posts/pwned3-infra-writeup/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-17T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-03-17T00:00:00+00:00" />



    
      <base href="http://www.atteniemi.com/posts/pwned3-infra-writeup/">
    
    <title>
  pwnED 3 infrastructure writeup Â· Atte Niemi
</title>

    
      <link rel="canonical" href="http://www.atteniemi.com/posts/pwned3-infra-writeup/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="http://www.atteniemi.com/css/coder.min.a4f332213a21ce8eb521670c614470c58923aaaf385e2a73982c31dd7642decb.css" integrity="sha256-pPMyITohzo61IWcMYURwxYkjqq84XipzmCwx3XZC3ss=" crossorigin="anonymous" media="screen" />
    

    

    
      
        
        
        <link rel="stylesheet" href="http://www.atteniemi.com/css/coder-dark.min.83a2010dac9f59f943b3004cd6c4f230507ad036da635d3621401d42ec4e2835.css" integrity="sha256-g6IBDayfWflDswBM1sTyMFB60DbaY102IUAdQuxOKDU=" crossorigin="anonymous" media="screen" />
      
    

    

    

    

    <link rel="icon" type="image/png" href="http://www.atteniemi.com/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="http://www.atteniemi.com/images/favicon-16x16.png" sizes="16x16">

    <meta name="generator" content="Hugo 0.94.2" />
  </head>

  
  
    
  
  <body class="colorscheme-dark">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="http://www.atteniemi.com/">
      Atte Niemi
    </a>
    
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="http://www.atteniemi.com/posts/">Blog</a>
          </li>
        
      
      
    </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">pwnED 3 infrastructure writeup</h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fas fa-calendar"></i>
              <time datetime='2022-03-17T00:00:00Z'>
                March 17, 2022
              </time>
            </span>
            <span class="reading-time">
              <i class="fas fa-clock"></i>
              5-minute read
            </span>
          </div>
          
          
        </div>
      </header>

      <div>
        
        <p>This post is going to be about the infrastructure behind pwnEd 3, the third installment of the annual CTF competition hosted by SIGINT.
45 teams or approximately 155 users signed up. We used Google Cloud Platform to host CTFd, and DigitalOcean to host our challenges on a Kubernetes cluster.</p>
<h4 id="ctfd">CTFd</h4>
<p>The complete CTFd terraform deployment is available <a href="https://github.com/hur/ctfd-gcp">here</a>. CTFd is deployed on App Engine Flex, which allows for scaling the number of replicas up and down very easily, with load balancing and health checks and other nice-to-haves. We used Redis Memorystore as a cache for CTFd. The smallest available Redis instance was more than enough for our CTF, and CTFd mkes efficient use of a cache with a ~99% cache hit rate. We used Cloud SQL as the database for CTFd. The combination of App Engine Flec, Cloud SQL and Redis Memorystore allows for easy scaling up of all the components of CTFd. Before the competition, we had a single instance of CTFd for uploading challenges and other administrative tasks. The night before the CTF we bumped the number of replicas up to 3.</p>
<p>We also used a Google Storage Bucket for CTFd&rsquo;s challenge storage. This required setting up a service account with a HMAC key for S3 interoperability, since CTFd expects a S3 bucket. Public access to the bucket is disabled but users can access files via CTFd, making our challenge files safe from pre-CTF enumeration.</p>
<p>Everything in this deployment was in a private VPC. Well, the google-managed Cloud SQL and Redis don&rsquo;t technically exist in the VPC, but with a VPC access connector for Cloud SQL and VPC Peering for Redis and public IP disabled for both, they can only be accessed from the VPC. Then, the only publicly available endpoint is the App Engine Flex application. Access to storage buckets was via IAM permissions on the app engine service account.</p>
<h4 id="challenges">Challenges</h4>
<p>We hosted challenges on a DigitalOcean Kubernetes cluster with 5 nodes.
I wrote a helm template to allow deploying challenges easily.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: {{ <span style="color:#ae81ff">$challenge.name }}-deployment</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: {{ <span style="color:#ae81ff">$challenge.name }}-namespace </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>: 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">challenge</span>: {{ <span style="color:#ae81ff">$challenge.name }}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">category</span>: {{ <span style="color:#ae81ff">$challenge.category }} </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: {{ <span style="color:#ae81ff">$challenge.replicas }}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>: 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">challenge</span>: {{ <span style="color:#ae81ff">$challenge.name }}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">challenge</span>: {{ <span style="color:#ae81ff">$challenge.name }}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">category</span>: {{ <span style="color:#ae81ff">$challenge.category }} </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">enableServiceLinks</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">automountServiceAccountToken</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># We want pods of a challenge to be evenly spread across nodes for redundancy</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">topologySpreadConstraints</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">maxSkew</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">topologyKey</span>: <span style="color:#ae81ff">kubernetes.io/hostname</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">whenUnsatisfiable</span>: <span style="color:#ae81ff">DoNotSchedule</span> <span style="color:#75715e"># Don&#39;t schedule 2 of the same pod onto the same node</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">labelSelector</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">challenge</span>: {{ <span style="color:#ae81ff">$challenge.name }} </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullSecrets</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: {{ <span style="color:#ae81ff">$top.Values.doRegistrySecretName }}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: {{ <span style="color:#ae81ff">$challenge.name }}</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">image</span>: {{ <span style="color:#ae81ff">$challenge.image }}</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">Always</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">containerPort</span>: {{ <span style="color:#ae81ff">$challenge.containerPort }} </span>
</span></span></code></pre></div><p>Each pod was behind a simple ClusterIP service.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: {{ <span style="color:#ae81ff">$challenge.name }}-service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: {{ <span style="color:#ae81ff">$challenge.name }}-namespace</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">category</span>: {{ <span style="color:#ae81ff">$challenge.category }}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">challenge</span>: {{ <span style="color:#ae81ff">$challenge.name }} </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">challenge</span>: {{ <span style="color:#ae81ff">$challenge.name }}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">port</span>: {{ <span style="color:#ae81ff">$challenge.containerPort }} </span>
</span></span><span style="display:flex;"><span>{{ <span style="color:#ae81ff">end }}</span>
</span></span></code></pre></div><p>To allow connections to the services from outside the cluster, we deployed nginx-ingress to perform the load balancing, with 3 replicas of the ingress controller for redundancy.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">ingress-nginx</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">controller</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">externalTrafficPolicy</span>: <span style="color:#ae81ff">Local</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">replicaCount</span>: <span style="color:#ae81ff">3</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># spread the ingress controllers across nodes for reliability</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">topologySpreadConstraints</span>: 
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">maxSkew</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">topologyKey</span>: <span style="color:#ae81ff">kubernetes.io/hostname</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">whenUnsatisfiable</span>: <span style="color:#ae81ff">DoNotSchedule </span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">labelSelector</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">app.kubernetes.io/component</span>: <span style="color:#ae81ff">controller</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># This should be the same as the release name</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">app.kubernetes.io/instance</span>: <span style="color:#ae81ff">challenges</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">config</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">use-proxy-protocol</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><p>This was preferred over having a load balancer for each service as they are $10/month per node, so price can stack up quite fast especially if we want our load balancers to be highly available.</p>
<p>For routing to different challenges, we considered 2 options. Name based virtual hosting and TCP port based routing.</p>
<p>Name based virtual hosting routes based on subdomain, so web1.challenges.sigint.mx could point to a web challenge. This looks quite nice, but doesn&rsquo;t support TCP challenges and there was concern that people might be able to enumerate our subdomains before the CTF.</p>
<p>Port based routing simply points challenges.sigint.mx:4773 to a challenge, and it supports general TCP ports so challenges that should be connected to via  <code>netcat</code>  can be routed to as well. This is what we used in pwnEd 3, and it worked well. For each challenge, we configured a routing rule to the challenge&rsquo;s service.</p>
<h5 id="challenge-upload-workflow">Challenge upload workflow</h5>
<p>With our templates in place, the workflow for deploying the challenge was simple.</p>
<ol>
<li>Build and push a docker image of the challenge to a private docker repository.</li>
<li>Add the following to our <code>values.yaml</code> file</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">tcp_challenges</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">name</span>: <span style="color:#ae81ff">ssh01</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">registry.digitalocean.com/&lt;registry_name&gt;/ssh01:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">1337</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">category</span>: <span style="color:#ae81ff">pwn</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">replicas</span>: <span style="color:#75715e">*replicaCount</span> <span style="color:#75715e"># defined earlier, = 3</span>
</span></span></code></pre></div><ol start="3">
<li>Add a TCP routing rule to ingress-nginx</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">ingress-nginx</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tcp</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">11000</span>: <span style="color:#ae81ff">ssh01-namespace/ssh01-service:1337</span>
</span></span></code></pre></div><ol start="4">
<li>Run <code>helm upgrade challenges .</code> to deploy the new challenge to the cluster</li>
</ol>
<p>This was a lot better than copy/pasting yaml files for each challenge, but for next year I plan on improving the workflow more, as this is still quite unpolished. The ideal would be to automatically build and deploy docker containers to the cluster from a git repo.</p>
<p>Having a declarative deployment is quite nice since the whole deployment is described in a few terraform and yaml files. Makes it very easy to reuse and improve for subsequent CTFs.
a</p>

      </div>


      <footer>
        


        
        
        
      </footer>
    </article>

    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js" id="MathJax-script"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [
          ['$', '$'], ['\\(', '\\)']
        ],
        processEscapes: true,
        processEnvironments: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    };
  </script>
  </section>

      </div>

      <footer class="footer">
  <section class="container">
    
    
    
    
  </section>
</footer>

    </main>

    

    

  </body>

</html>
