<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="Atte Niemi">
    <meta name="description" content="Atte Niemi&#39;s personal website">
    <meta name="keywords" content="blog,developer,personal">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="HTB Uni CTF Finals - Double Agents Write-up"/>
<meta name="twitter:description" content="Writeup of the Double Agents crypto challenge from the Hack The Box University CTF Finals"/>

    <meta property="og:title" content="HTB Uni CTF Finals - Double Agents Write-up" />
<meta property="og:description" content="Writeup of the Double Agents crypto challenge from the Hack The Box University CTF Finals" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://www.atteniemi.com/posts/htb-uni-ctf-double-agents/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-03-22T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-03-22T00:00:00+00:00" />



    
      <base href="http://www.atteniemi.com/posts/htb-uni-ctf-double-agents/">
    
    <title>
  HTB Uni CTF Finals - Double Agents Write-up Â· Atte Niemi
</title>

    
      <link rel="canonical" href="http://www.atteniemi.com/posts/htb-uni-ctf-double-agents/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="http://www.atteniemi.com/css/coder.min.a4f332213a21ce8eb521670c614470c58923aaaf385e2a73982c31dd7642decb.css" integrity="sha256-pPMyITohzo61IWcMYURwxYkjqq84XipzmCwx3XZC3ss=" crossorigin="anonymous" media="screen" />
    

    

    
      
        
        
        <link rel="stylesheet" href="http://www.atteniemi.com/css/coder-dark.min.83a2010dac9f59f943b3004cd6c4f230507ad036da635d3621401d42ec4e2835.css" integrity="sha256-g6IBDayfWflDswBM1sTyMFB60DbaY102IUAdQuxOKDU=" crossorigin="anonymous" media="screen" />
      
    

    

    

    

    <link rel="icon" type="image/png" href="http://www.atteniemi.com/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="http://www.atteniemi.com/images/favicon-16x16.png" sizes="16x16">

    <meta name="generator" content="Hugo 0.94.2" />
  </head>

  
  
    
  
  <body class="colorscheme-dark">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="http://www.atteniemi.com/">
      Atte Niemi
    </a>
    
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="http://www.atteniemi.com/posts/">Blog</a>
          </li>
        
      
      
    </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">HTB Uni CTF Finals - Double Agents Write-up</h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fas fa-calendar"></i>
              <time datetime='2021-03-22T00:00:00Z'>
                March 22, 2021
              </time>
            </span>
            <span class="reading-time">
              <i class="fas fa-clock"></i>
              2-minute read
            </span>
          </div>
          
          
        </div>
      </header>

      <div>
        
        <p><em>After a long investigation we have revealed the enemy&rsquo;s service, which provides their agents with any needed documents. Recent events indicate that there are double agents among us. We need to read the double_agents.txt file in order to identify their names and treat them accordingly. Can you do it?</em></p>
<p>We&rsquo;re given code for a server that accepts hex input and attempts to decrypt it using AES CBC to open a file. The server will also give us the decrypted hex back.</p>
<p>We notice an interesting thing about the server code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>cipher <span style="color:#f92672">=</span> AES<span style="color:#f92672">.</span>new(key, AES<span style="color:#f92672">.</span>MODE_CBC, key)
</span></span></code></pre></div><p>They are using the secret key as the IV every time! If we can leak the IV, we can forge a message and open the <code>double_agents.txt</code> file.</p>
<p>CBC decryption works as follows (where the ciphertext is separated into  blocks):
<img src="http://www.atteniemi.com/images/double-agents-writeup/cbc.png" alt="CBC"></p>
<p>Let&rsquo;s denote the decryption function $D(x)$ and let $\oplus$ stand for the XOR operation.</p>
<p>We have  $D(cipher_0) \oplus IV = plaintext_0$ and $D(cipher_1) \oplus cipher_0 = plaintext_1$</p>
<p>Thus, if we XOR them together, we get</p>
<p>$D(cipher_0) \oplus D(cipher_1) \oplus cipher_0 \oplus IV = plaintext_0 \oplus plaintext_1$</p>
<p>If both ciphertext blocks are zeroes, we have the following:</p>
<p>$D(0) \oplus D(0) \oplus 0 \oplus IV = IV$, thus we have $IV = plaintext_0 \oplus plaintext_1$ and $IV = key$, thus we can leak the key by sending two blocks of zeroes and xoring the output blocks together! We can then use the key to create the ciphertext that decrypts to <code>double_agents.txt</code>.</p>
<p>Using this, I wrote up a Python solution.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> Crypto.Cipher <span style="color:#f92672">import</span> AES
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> Crypto.Util.Padding <span style="color:#f92672">import</span> pad
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> Crypto.Util.number <span style="color:#f92672">import</span> long_to_bytes
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;00&#34;</span> <span style="color:#f92672">*</span> AES<span style="color:#f92672">.</span>block_size <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#34;docker.hackthebox.eu&#34;</span>, <span style="color:#ae81ff">31083</span>)
</span></span><span style="display:flex;"><span>r<span style="color:#f92672">.</span>recvline()
</span></span><span style="display:flex;"><span>r<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>decrypted <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span>recvline()[len(<span style="color:#e6db74">&#34;File not found: &#34;</span>):<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#75715e"># extract the decrypted hex</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># split in half</span>
</span></span><span style="display:flex;"><span>pt_1, pt_2 <span style="color:#f92672">=</span> decrypted[:len(decrypted)<span style="color:#f92672">//</span><span style="color:#ae81ff">2</span>], decrypted[len(decrypted)<span style="color:#f92672">//</span><span style="color:#ae81ff">2</span>:]
</span></span><span style="display:flex;"><span><span style="color:#75715e"># XOR the plaintexts and store the result bytes</span>
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span> long_to_bytes(int(pt_1, <span style="color:#ae81ff">16</span>) <span style="color:#f92672">^</span> int(pt_2, <span style="color:#ae81ff">16</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># create final ciphertext</span>
</span></span><span style="display:flex;"><span>a <span style="color:#f92672">=</span> AES<span style="color:#f92672">.</span>new(key, AES<span style="color:#f92672">.</span>MODE_CBC, key)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># The server does padding and unpadding so we&#39;ll do it too just to be safe!</span>
</span></span><span style="display:flex;"><span>final_payload <span style="color:#f92672">=</span> a<span style="color:#f92672">.</span>encrypt(pad(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;double_agents.txt&#34;</span>, AES<span style="color:#f92672">.</span>block_size))<span style="color:#f92672">.</span>hex()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#34;docker.hackthebox.eu&#34;</span>, <span style="color:#ae81ff">31083</span>)
</span></span><span style="display:flex;"><span>r<span style="color:#f92672">.</span>recvline()
</span></span><span style="display:flex;"><span>r<span style="color:#f92672">.</span>sendline(final_payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">21</span>):
</span></span><span style="display:flex;"><span>    response <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span>recvline()<span style="color:#f92672">.</span>decode()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> response<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#34;HTB&#34;</span>):
</span></span><span style="display:flex;"><span>        print(response<span style="color:#f92672">.</span>strip())
</span></span></code></pre></div><p>The file contains a bunch of lines with names of double agents, as well as the flag. The above solution prints out only the flag, for brevity.</p>
<p>Let&rsquo;s  run it!</p>
<p><img src="http://www.atteniemi.com/images/double-agents-writeup/double-agents-flag.png" alt="Flag"></p>
<p>and we have the flag!</p>

      </div>


      <footer>
        


        
        
        
      </footer>
    </article>

    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js" id="MathJax-script"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [
          ['$', '$'], ['\\(', '\\)']
        ],
        processEscapes: true,
        processEnvironments: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    };
  </script>
  </section>

      </div>

      <footer class="footer">
  <section class="container">
    
    
    
    
  </section>
</footer>

    </main>

    

    

  </body>

</html>
